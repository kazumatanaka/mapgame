<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ½é“åºœçœŒï¼†çœŒåºæ‰€åœ¨åœ°ãƒã‚¹ã‚¿ãƒ¼ (SVGç‰ˆ)</title>
    <style>
        body { font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; text-align: center; background-color: #f0f8ff; padding: 20px; }
        h1 { color: #333; font-size: 24px; margin-bottom: 10px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Menu Buttons */
        .menu-btn { display: block; width: 100%; margin: 10px 0; padding: 15px; font-size: 18px; color: white; background-color: #4CAF50; border: none; border-radius: 8px; cursor: pointer; transition: background 0.3s; }
        .menu-btn:hover { background-color: #45a049; }
        .menu-btn.hard { background-color: #2196F3; }

        /* Game Area */
        #game-area { display: none; }
        .question-box { font-size: 32px; font-weight: bold; margin: 10px 0; min-height: 50px; color: #333; }
        .sub-text { font-size: 16px; color: #666; margin-bottom: 10px; }

        /* SVG Map Container */
        #map-container {
            width: 100%;
            max-width: 600px;
            height: auto;
            margin: 0 auto;
            border: 1px solid #ccc;
            background-color: #fff;
        }
        /* Styles applied to the loaded SVG */
        svg { width: 100%; height: auto; }
        path { fill: #ddd; stroke: #fff; stroke-width: 1; cursor: pointer; transition: fill 0.2s; }
        path:hover { fill: #ccc; }
        path.active { fill: #ff5722 !important; } /* Question highlight */
        path.correct { fill: #4CAF50 !important; } /* Correct answer */
        path.wrong { fill: #F44336 !important; } /* Wrong answer */

        /* Voice Button */
        #mic-btn {
            font-size: 20px; padding: 15px 30px; border-radius: 50px; border: none;
            background-color: #ff5722; color: white; cursor: pointer; margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        #mic-btn.listening { background-color: #dc3545; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .result-msg { font-size: 20px; font-weight: bold; margin-top: 15px; min-height: 30px; }
        .result-msg.correct { color: #2e7d32; }
        .result-msg.wrong { color: #d32f2f; }

        .back-btn { margin-top: 20px; background: #777; padding: 8px 16px; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div id="menu-area">
        <h1>ğŸ‡¯ğŸ‡µ æ—¥æœ¬åœ°å›³ï¼†çœŒåºæ‰€åœ¨åœ° (SVGç‰ˆ)</h1>
        <p>â€» japan.svg ãŒåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«å¿…è¦ã§ã™</p>
        <button class="menu-btn" onclick="startGame(1)">1. åœ°å›³ã‹ã‚‰ã€ŒçœŒåãƒ»çœŒåºæ‰€åœ¨åœ°ã€ã‚’è¨€ã†</button>
        <button class="menu-btn" onclick="startGame(2)">2. çœŒåã‚’è¦‹ã¦ã€Œåœ°å›³ã€ã‚’å½“ã¦ã‚‹</button>
        <button class="menu-btn hard" onclick="startGame(3)">3. çœŒåã‹ã‚‰ã€ŒçœŒåºæ‰€åœ¨åœ°ã€ã‚’è¨€ã†ï¼ˆé•ã†19å€‹ï¼‰</button>
        <button class="menu-btn hard" onclick="startGame(4)">4. çœŒåºæ‰€åœ¨åœ°ã‹ã‚‰ã€ŒçœŒåã€ã‚’è¨€ã†ï¼ˆé•ã†19å€‹ï¼‰</button>
    </div>

    <div id="game-area">
        <h2 id="mode-title">ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰</h2>
        <div class="question-box" id="question-text">ã“ã“ã«å•é¡ŒãŒå‡ºã¾ã™</div>
        <div class="sub-text" id="instruction-text">èª¬æ˜</div>

        <div id="map-container">
            <p style="padding:20px;">åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­...<br>(è¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ japan.svg ã‚’ç¢ºèªã—ã¦ãã ã•ã„)</p>
        </div>

        <div id="voice-controls">
            <button id="mic-btn" onclick="toggleRecognition()">ğŸ¤ ç­”ãˆã‚‹</button>
            <div id="voice-status" style="margin-top:5px; color:#666;">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©±ã—ã¦ã­</div>
        </div>

        <div class="result-msg" id="result-message"></div>
        <button class="back-btn" onclick="showMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
    </div>
</div>

<script>
    // --- Data: 47 Prefectures ---
    // diff: true = çœŒåºæ‰€åœ¨åœ°ã¨çœŒåãŒé•ã†ï¼ˆã¾ãŸã¯ç‰¹æ®Šãªï¼‰19åœ°åŸŸ
    const prefs = [
        { id: 1, name: "åŒ—æµ·é“", capital: "æœ­å¹Œ", yomi: "ã»ã£ã‹ã„ã©ã†", cYomi: "ã•ã£ã½ã‚", diff: true },
        { id: 2, name: "é’æ£®", capital: "é’æ£®", yomi: "ã‚ãŠã‚‚ã‚Š", cYomi: "ã‚ãŠã‚‚ã‚Š", diff: false },
        { id: 3, name: "å²©æ‰‹", capital: "ç››å²¡", yomi: "ã„ã‚ã¦", cYomi: "ã‚‚ã‚ŠãŠã‹", diff: true },
        { id: 4, name: "å®®åŸ", capital: "ä»™å°", yomi: "ã¿ã‚„ã", cYomi: "ã›ã‚“ã ã„", diff: true },
        { id: 5, name: "ç§‹ç”°", capital: "ç§‹ç”°", yomi: "ã‚ããŸ", cYomi: "ã‚ããŸ", diff: false },
        { id: 6, name: "å±±å½¢", capital: "å±±å½¢", yomi: "ã‚„ã¾ãŒãŸ", cYomi: "ã‚„ã¾ãŒãŸ", diff: false },
        { id: 7, name: "ç¦å³¶", capital: "ç¦å³¶", yomi: "ãµãã—ã¾", cYomi: "ãµãã—ã¾", diff: false },
        { id: 8, name: "èŒ¨åŸ", capital: "æ°´æˆ¸", yomi: "ã„ã°ã‚‰ã", cYomi: "ã¿ã¨", diff: true },
        { id: 9, name: "æ ƒæœ¨", capital: "å®‡éƒ½å®®", yomi: "ã¨ã¡ã", cYomi: "ã†ã¤ã®ã¿ã‚„", diff: true },
        { id: 10, name: "ç¾¤é¦¬", capital: "å‰æ©‹", yomi: "ãã‚“ã¾", cYomi: "ã¾ãˆã°ã—", diff: true },
        { id: 11, name: "åŸ¼ç‰", capital: "ã•ã„ãŸã¾", yomi: "ã•ã„ãŸã¾", cYomi: "ã•ã„ãŸã¾", diff: true }, 
        { id: 12, name: "åƒè‘‰", capital: "åƒè‘‰", yomi: "ã¡ã°", cYomi: "ã¡ã°", diff: false },
        { id: 13, name: "æ±äº¬", capital: "æ–°å®¿", yomi: "ã¨ã†ãã‚‡ã†", cYomi: "ã—ã‚“ã˜ã‚…ã", diff: true },
        { id: 14, name: "ç¥å¥ˆå·", capital: "æ¨ªæµœ", yomi: "ã‹ãªãŒã‚", cYomi: "ã‚ˆã“ã¯ã¾", diff: true },
        { id: 15, name: "æ–°æ½Ÿ", capital: "æ–°æ½Ÿ", yomi: "ã«ã„ãŒãŸ", cYomi: "ã«ã„ãŒãŸ", diff: false },
        { id: 16, name: "å¯Œå±±", capital: "å¯Œå±±", yomi: "ã¨ã‚„ã¾", cYomi: "ã¨ã‚„ã¾", diff: false },
        { id: 17, name: "çŸ³å·", capital: "é‡‘æ²¢", yomi: "ã„ã—ã‹ã‚", cYomi: "ã‹ãªã–ã‚", diff: true },
        { id: 18, name: "ç¦äº•", capital: "ç¦äº•", yomi: "ãµãã„", cYomi: "ãµãã„", diff: false },
        { id: 19, name: "å±±æ¢¨", capital: "ç”²åºœ", yomi: "ã‚„ã¾ãªã—", cYomi: "ã“ã†ãµ", diff: true },
        { id: 20, name: "é•·é‡", capital: "é•·é‡", yomi: "ãªãŒã®", cYomi: "ãªãŒã®", diff: false },
        { id: 21, name: "å²é˜œ", capital: "å²é˜œ", yomi: "ããµ", cYomi: "ããµ", diff: false },
        { id: 22, name: "é™å²¡", capital: "é™å²¡", yomi: "ã—ãšãŠã‹", cYomi: "ã—ãšãŠã‹", diff: false },
        { id: 23, name: "æ„›çŸ¥", capital: "åå¤å±‹", yomi: "ã‚ã„ã¡", cYomi: "ãªã”ã‚„", diff: true },
        { id: 24, name: "ä¸‰é‡", capital: "æ´¥", yomi: "ã¿ãˆ", cYomi: "ã¤", diff: true },
        { id: 25, name: "æ»‹è³€", capital: "å¤§æ´¥", yomi: "ã—ãŒ", cYomi: "ãŠãŠã¤", diff: true },
        { id: 26, name: "äº¬éƒ½", capital: "äº¬éƒ½", yomi: "ãã‚‡ã†ã¨", cYomi: "ãã‚‡ã†ã¨", diff: false },
        { id: 27, name: "å¤§é˜ª", capital: "å¤§é˜ª", yomi: "ãŠãŠã•ã‹", cYomi: "ãŠãŠã•ã‹", diff: false },
        { id: 28, name: "å…µåº«", capital: "ç¥æˆ¸", yomi: "ã²ã‚‡ã†ã”", cYomi: "ã“ã†ã¹", diff: true },
        { id: 29, name: "å¥ˆè‰¯", capital: "å¥ˆè‰¯", yomi: "ãªã‚‰", cYomi: "ãªã‚‰", diff: false },
        { id: 30, name: "å’Œæ­Œå±±", capital: "å’Œæ­Œå±±", yomi: "ã‚ã‹ã‚„ã¾", cYomi: "ã‚ã‹ã‚„ã¾", diff: false },
        { id: 31, name: "é³¥å–", capital: "é³¥å–", yomi: "ã¨ã£ã¨ã‚Š", cYomi: "ã¨ã£ã¨ã‚Š", diff: false },
        { id: 32, name: "å³¶æ ¹", capital: "æ¾æ±Ÿ", yomi: "ã—ã¾ã­", cYomi: "ã¾ã¤ãˆ", diff: true },
        { id: 33, name: "å²¡å±±", capital: "å²¡å±±", yomi: "ãŠã‹ã‚„ã¾", cYomi: "ãŠã‹ã‚„ã¾", diff: false },
        { id: 34, name: "åºƒå³¶", capital: "åºƒå³¶", yomi: "ã²ã‚ã—ã¾", cYomi: "ã²ã‚ã—ã¾", diff: false },
        { id: 35, name: "å±±å£", capital: "å±±å£", yomi: "ã‚„ã¾ãã¡", cYomi: "ã‚„ã¾ãã¡", diff: false },
        { id: 36, name: "å¾³å³¶", capital: "å¾³å³¶", yomi: "ã¨ãã—ã¾", cYomi: "ã¨ãã—ã¾", diff: false },
        { id: 37, name: "é¦™å·", capital: "é«˜æ¾", yomi: "ã‹ãŒã‚", cYomi: "ãŸã‹ã¾ã¤", diff: true },
        { id: 38, name: "æ„›åª›", capital: "æ¾å±±", yomi: "ãˆã²ã‚", cYomi: "ã¾ã¤ã‚„ã¾", diff: true },
        { id: 39, name: "é«˜çŸ¥", capital: "é«˜çŸ¥", yomi: "ã“ã†ã¡", cYomi: "ã“ã†ã¡", diff: false },
        { id: 40, name: "ç¦å²¡", capital: "ç¦å²¡", yomi: "ãµããŠã‹", cYomi: "ãµããŠã‹", diff: false },
        { id: 41, name: "ä½è³€", capital: "ä½è³€", yomi: "ã•ãŒ", cYomi: "ã•ãŒ", diff: false },
        { id: 42, name: "é•·å´", capital: "é•·å´", yomi: "ãªãŒã•ã", cYomi: "ãªãŒã•ã", diff: false },
        { id: 43, name: "ç†Šæœ¬", capital: "ç†Šæœ¬", yomi: "ãã¾ã‚‚ã¨", cYomi: "ãã¾ã‚‚ã¨", diff: false },
        { id: 44, name: "å¤§åˆ†", capital: "å¤§åˆ†", yomi: "ãŠãŠã„ãŸ", cYomi: "ãŠãŠã„ãŸ", diff: false },
        { id: 45, name: "å®®å´", capital: "å®®å´", yomi: "ã¿ã‚„ã–ã", cYomi: "ã¿ã‚„ã–ã", diff: false },
        { id: 46, name: "é¹¿å…å³¶", capital: "é¹¿å…å³¶", yomi: "ã‹ã”ã—ã¾", cYomi: "ã‹ã”ã—ã¾", diff: false },
        { id: 47, name: "æ²–ç¸„", capital: "é‚£è¦‡", yomi: "ãŠããªã‚", cYomi: "ãªã¯", diff: true }
    ];

    let currentMode = 0;
    let currentPref = null;
    let recognition;
    let isListening = false;
    let svgDoc = null;

    // --- SVG Loading ---
    window.onload = function() {
        fetch('japan.svg')
            .then(response => response.text())
            .then(data => {
                document.getElementById('map-container').innerHTML = data;
                // Add click handlers to SVG paths
                const svg = document.querySelector('svg');
                if (svg) {
                    // Assume paths have IDs like "pref-1", "JP-01", or just indices. 
                    // Adjust selector if your SVG uses specific classes.
                    const paths = svg.querySelectorAll('path');
                    paths.forEach((path, index) => {
                        // Attempt to map path to ID. 
                        // Strategy: Use path ID if it contains numbers, else use index + 1
                        let idNum = parseInt(path.id.replace(/\D/g, ''));
                        if (!idNum || idNum > 47) idNum = index + 1; // Fallback

                        path.dataset.prefId = idNum;
                        path.onclick = () => handleMapClick(idNum);
                    });
                }
            })
            .catch(err => {
                document.getElementById('map-container').innerHTML = "<p style='color:red;'>japan.svgã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
                console.error(err);
            });
    };

    // --- Voice Setup ---
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onstart = () => {
            isListening = true;
            document.getElementById('mic-btn').classList.add('listening');
            document.getElementById('voice-status').innerText = "èã„ã¦ã„ã¾ã™...";
        };
        recognition.onend = () => {
            isListening = false;
            document.getElementById('mic-btn').classList.remove('listening');
            document.getElementById('voice-status').innerText = "ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©±ã—ã¦ã­";
        };
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            checkVoiceAnswer(transcript);
        };
    }

    function showMenu() {
        document.getElementById('menu-area').style.display = 'block';
        document.getElementById('game-area').style.display = 'none';
        resetMapColors();
    }

    function startGame(mode) {
        currentMode = mode;
        document.getElementById('menu-area').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';
        document.getElementById('result-message').innerText = "";
        
        // Setup Titles
        const titles = ["", "1. åœ°å›³ã‹ã‚‰ã€ŒçœŒåãƒ»çœŒåºæ‰€åœ¨åœ°ã€", "2. çœŒåã‹ã‚‰ã€Œåœ°å›³ã€", "3. çœŒåâ†’çœŒåºæ‰€åœ¨åœ° (19é¸)", "4. çœŒåºæ‰€åœ¨åœ°â†’çœŒå (19é¸)"];
        document.getElementById('mode-title').innerText = titles[mode];

        // UI Setup
        const voice = document.getElementById('voice-controls');
        // Mode 2 uses click only
        voice.style.display = (mode === 2) ? "none" : "block";

        nextQuestion();
    }

    function nextQuestion() {
        resetMapColors();
        document.getElementById('result-message').innerText = "";

        // Filter Prefs
        let pool = prefs;
        if (currentMode === 3 || currentMode === 4) {
            pool = prefs.filter(p => p.diff);
        }
        
        currentPref = pool[Math.floor(Math.random() * pool.length)];

        // Display Logic
        const qText = document.getElementById('question-text');
        const iText = document.getElementById('instruction-text');

        if (currentMode === 1) {
            qText.innerText = "ã“ã“ã¯ã©ã“ï¼Ÿ";
            iText.innerText = "ã€ŒçœŒåã€ã¨ã€ŒçœŒåºæ‰€åœ¨åœ°ã€ã‚’ç­”ãˆã¦ã­";
            highlightMap(currentPref.id);
        } else if (currentMode === 2) {
            qText.innerText = `${currentPref.name}çœŒ`;
            iText.innerText = "åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã­";
        } else if (currentMode === 3) {
            qText.innerText = `${currentPref.name}çœŒ`;
            iText.innerText = "çœŒåºæ‰€åœ¨åœ°ã¯ã©ã“ï¼Ÿï¼ˆéŸ³å£°ã§å›ç­”ï¼‰";
        } else if (currentMode === 4) {
            qText.innerText = `${currentPref.capital}å¸‚`; // Tokyo special handling if needed
            if(currentPref.name === "æ±äº¬") qText.innerText = "æ–°å®¿åŒºï¼ˆæ±äº¬éƒ½åºï¼‰";
            iText.innerText = "ã“ã‚Œã¯ä½•çœŒã®çœŒåºæ‰€åœ¨åœ°ï¼Ÿï¼ˆéŸ³å£°ã§å›ç­”ï¼‰";
        }
    }

    // --- Actions ---

    function toggleRecognition() {
        if (!recognition) return alert("éŸ³å£°èªè­˜éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™");
        if (isListening) recognition.stop();
        else recognition.start();
    }

    function checkVoiceAnswer(text) {
        text = text.replace(/çœŒ|å¸‚|åºœ|éƒ½|åŒº/g, ""); // Remove suffix
        const pName = currentPref.name.replace(/çœŒ|å¸‚|åºœ|éƒ½/g, "");
        const pCap = currentPref.capital.replace(/çœŒ|å¸‚|åºœ|éƒ½/g, "");
        const pYomi = currentPref.yomi;
        const cYomi = currentPref.cYomi;

        let isCorrect = false;
        let msg = "";

        if (currentMode === 1) {
            // Check both
            const hasName = text.includes(pName) || text.includes(pYomi);
            const hasCap = text.includes(pCap) || text.includes(cYomi);
            if (hasName && hasCap) {
                isCorrect = true;
                msg = `æ­£è§£ï¼ ${currentPref.name}ï¼ˆ${currentPref.capital}ï¼‰`;
            } else if (hasName) {
                msg = "çœŒåã¯æ­£è§£ï¼çœŒåºæ‰€åœ¨åœ°ã‚‚è¨€ã£ã¦ã­ã€‚";
            } else {
                msg = `æ®‹å¿µ... æ­£è§£ã¯ ${currentPref.name}ãƒ»${currentPref.capital}`;
            }
        } else if (currentMode === 3) {
            // Target: Capital
            if (text.includes(pCap) || text.includes(cYomi)) {
                isCorrect = true;
                msg = `æ­£è§£ï¼ ${currentPref.capital}`;
            } else {
                msg = `ä¸æ­£è§£... æ­£è§£ã¯ ${currentPref.capital}`;
            }
        } else if (currentMode === 4) {
            // Target: Pref Name
            if (text.includes(pName) || text.includes(pYomi)) {
                isCorrect = true;
                msg = `æ­£è§£ï¼ ${currentPref.name}çœŒ`;
            } else {
                msg = `ä¸æ­£è§£... æ­£è§£ã¯ ${currentPref.name}çœŒ`;
            }
        }

        showResult(isCorrect, msg);
    }

    function handleMapClick(id) {
        if (currentMode !== 2) return;
        
        // Find clicked pref object
        const clickedPref = prefs.find(p => p.id === id);
        if (!clickedPref) return;

        let isCorrect = false;
        let msg = "";

        if (id === currentPref.id) {
            isCorrect = true;
            msg = `æ­£è§£ï¼ãã“ãŒ ${currentPref.name} ã§ã™ã€‚`;
            colorPath(id, 'correct');
        } else {
            msg = `é•ã†ã‚ˆã€ãã“ã¯ ${clickedPref.name} ã§ã™ã€‚`;
            colorPath(id, 'wrong');
        }
        showResult(isCorrect, msg);
    }

    function showResult(isCorrect, msg) {
        const div = document.getElementById('result-message');
        div.innerText = msg;
        div.className = "result-msg " + (isCorrect ? "correct" : "wrong");
        
        if (isCorrect) {
            setTimeout(nextQuestion, 2000);
        }
    }

    // --- Map Helpers ---
    function resetMapColors() {
        const paths = document.querySelectorAll('path');
        paths.forEach(p => p.classList.remove('active', 'correct', 'wrong'));
    }

    function highlightMap(id) {
        const path = document.querySelector(`path[data-pref-id='${id}']`);
        if (path) path.classList.add('active');
    }

    function colorPath(id, cls) {
        const path = document.querySelector(`path[data-pref-id='${id}']`);
        if (path) path.classList.add(cls);
    }

</script>
</body>
</html>