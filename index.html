<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ—¥æœ¬åœ°å›³ã‚¯ã‚¤ã‚ºï¼ˆGeoloniaç‰ˆï¼‰</title>
<style>
  body { font-family: "Hiragino Maru Gothic Pro", "Yu Gothic", sans-serif; text-align: center; background-color: #e0f7fa; padding: 20px; }
  
  /* åœ°å›³è¡¨ç¤ºã‚¨ãƒªã‚¢ */
  #map-container {
    width: 100%;
    max-width: 800px;
    margin: 10px auto;
    border: 4px solid #4dd0e1;
    border-radius: 10px;
    background: white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  
  /* SVGã®è¨­å®š */
  svg { width: 100%; height: auto; display: block; }
  
  /* åœ°å›³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .prefecture polygon, .prefecture path { 
    fill: #EEEEEE; /* å…ƒã®è‰² */
    stroke: #999; 
    stroke-width: 1px; 
    cursor: pointer;
    transition: fill 0.2s; 
  }
  
  /* ãƒã‚¦ã‚¹ã‚’ä¹—ã›ãŸæ™‚ */
  .prefecture:hover polygon, .prefecture:hover path { 
    fill: #b2ebf2; 
  }
  
  /* â˜…é‡è¦ï¼šå‡ºé¡Œä¸­ã®è‰²ï¼ˆèµ¤ï¼‰ */
  /* gã‚¿ã‚°ã«activeãŒã¤ã„ãŸæ™‚ã€ãã®ä¸­ã®ãƒãƒªã‚´ãƒ³ã‚’èµ¤ãã™ã‚‹ */
  g.active polygon, g.active path { 
    fill: #ff5252 !important; 
    stroke: #ff5252 !important;
  }

  /* UI */
  #message { font-size: 22px; font-weight: bold; color: #bf360c; margin: 10px; min-height: 1.5em; }
  #status { color: #555; font-size: 14px; margin-bottom: 20px;}
  button { padding: 15px 40px; font-size: 20px; background: #ffca28; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 4px #c6a700; }
  
</style>
</head>
<body>

<h1>ğŸ—¾ æ—¥æœ¬åœ°å›³ã‚¯ã‚¤ã‚º</h1>

<div id="game-area">
  <div id="message">åœ°å›³ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
  <div id="status"></div>
  <button id="btn-start" onclick="startGame()" disabled>æº–å‚™ä¸­</button>
</div>

<div id="map-container">
  </div>

<script>
  // --- 1. ãƒ‡ãƒ¼ã‚¿å®šç¾© (JISã‚³ãƒ¼ãƒ‰ 1ã€œ47) ---
  const prefectures = [
    { jis: 1, names: ["åŒ—æµ·é“", "ã»ã£ã‹ã„ã©ã†"], capital: "æœ­å¹Œ", capitalNames: ["æœ­å¹Œ", "ã•ã£ã½ã‚"] },
    { jis: 2, names: ["é’æ£®", "é’æ£®çœŒ", "ã‚ãŠã‚‚ã‚Š"], capital: "é’æ£®", capitalNames: ["é’æ£®", "ã‚ãŠã‚‚ã‚Š"] },
    { jis: 3, names: ["å²©æ‰‹", "å²©æ‰‹çœŒ", "ã„ã‚ã¦"], capital: "ç››å²¡", capitalNames: ["ç››å²¡", "ã‚‚ã‚ŠãŠã‹"] },
    { jis: 4, names: ["å®®åŸ", "å®®åŸçœŒ", "ã¿ã‚„ã"], capital: "ä»™å°", capitalNames: ["ä»™å°", "ã›ã‚“ã ã„"] },
    { jis: 5, names: ["ç§‹ç”°", "ç§‹ç”°çœŒ", "ã‚ããŸ"], capital: "ç§‹ç”°", capitalNames: ["ç§‹ç”°", "ã‚ããŸ"] },
    { jis: 6, names: ["å±±å½¢", "å±±å½¢çœŒ", "ã‚„ã¾ãŒãŸ"], capital: "å±±å½¢", capitalNames: ["å±±å½¢", "ã‚„ã¾ãŒãŸ"] },
    { jis: 7, names: ["ç¦å³¶", "ç¦å³¶çœŒ", "ãµãã—ã¾"], capital: "ç¦å³¶", capitalNames: ["ç¦å³¶", "ãµãã—ã¾"] },
    { jis: 8, names: ["èŒ¨åŸ", "èŒ¨åŸçœŒ", "ã„ã°ã‚‰ã"], capital: "æ°´æˆ¸", capitalNames: ["æ°´æˆ¸", "ã¿ã¨"] },
    { jis: 9, names: ["æ ƒæœ¨", "æ ƒæœ¨çœŒ", "ã¨ã¡ã"], capital: "å®‡éƒ½å®®", capitalNames: ["å®‡éƒ½å®®", "ã†ã¤ã®ã¿ã‚„"] },
    { jis: 10, names: ["ç¾¤é¦¬", "ç¾¤é¦¬çœŒ", "ãã‚“ã¾"], capital: "å‰æ©‹", capitalNames: ["å‰æ©‹", "ã¾ãˆã°ã—"] },
    { jis: 11, names: ["åŸ¼ç‰", "åŸ¼ç‰çœŒ", "ã•ã„ãŸã¾"], capital: "ã•ã„ãŸã¾", capitalNames: ["ã•ã„ãŸã¾", "æµ¦å’Œ"] },
    { jis: 12, names: ["åƒè‘‰", "åƒè‘‰çœŒ", "ã¡ã°"], capital: "åƒè‘‰", capitalNames: ["åƒè‘‰", "ã¡ã°"] },
    { jis: 13, names: ["æ±äº¬", "æ±äº¬éƒ½", "ã¨ã†ãã‚‡ã†"], capital: "æ±äº¬", capitalNames: ["æ±äº¬", "æ–°å®¿"] },
    { jis: 14, names: ["ç¥å¥ˆå·", "ç¥å¥ˆå·çœŒ", "ã‹ãªãŒã‚"], capital: "æ¨ªæµœ", capitalNames: ["æ¨ªæµœ", "ã‚ˆã“ã¯ã¾"] },
    { jis: 15, names: ["æ–°æ½Ÿ", "æ–°æ½ŸçœŒ", "ã«ã„ãŒãŸ"], capital: "æ–°æ½Ÿ", capitalNames: ["æ–°æ½Ÿ", "ã«ã„ãŒãŸ"] },
    { jis: 16, names: ["å¯Œå±±", "å¯Œå±±çœŒ", "ã¨ã‚„ã¾"], capital: "å¯Œå±±", capitalNames: ["å¯Œå±±", "ã¨ã‚„ã¾"] },
    { jis: 17, names: ["çŸ³å·", "çŸ³å·çœŒ", "ã„ã—ã‹ã‚"], capital: "é‡‘æ²¢", capitalNames: ["é‡‘æ²¢", "ã‹ãªã–ã‚"] },
    { jis: 18, names: ["ç¦äº•", "ç¦äº•çœŒ", "ãµãã„"], capital: "ç¦äº•", capitalNames: ["ç¦äº•", "ãµãã„"] },
    { jis: 19, names: ["å±±æ¢¨", "å±±æ¢¨çœŒ", "ã‚„ã¾ãªã—"], capital: "ç”²åºœ", capitalNames: ["ç”²åºœ", "ã“ã†ãµ"] },
    { jis: 20, names: ["é•·é‡", "é•·é‡çœŒ", "ãªãŒã®"], capital: "é•·é‡", capitalNames: ["é•·é‡", "ãªãŒã®"] },
    { jis: 21, names: ["å²é˜œ", "å²é˜œçœŒ", "ããµ"], capital: "å²é˜œ", capitalNames: ["å²é˜œ", "ããµ"] },
    { jis: 22, names: ["é™å²¡", "é™å²¡çœŒ", "ã—ãšãŠã‹"], capital: "é™å²¡", capitalNames: ["é™å²¡", "ã—ãšãŠã‹"] },
    { jis: 23, names: ["æ„›çŸ¥", "æ„›çŸ¥çœŒ", "ã‚ã„ã¡"], capital: "åå¤å±‹", capitalNames: ["åå¤å±‹", "ãªã”ã‚„"] },
    { jis: 24, names: ["ä¸‰é‡", "ä¸‰é‡çœŒ", "ã¿ãˆ"], capital: "æ´¥", capitalNames: ["æ´¥", "ã¤"] },
    { jis: 25, names: ["æ»‹è³€", "æ»‹è³€çœŒ", "ã—ãŒ"], capital: "å¤§æ´¥", capitalNames: ["å¤§æ´¥", "ãŠãŠã¤"] },
    { jis: 26, names: ["äº¬éƒ½", "äº¬éƒ½åºœ", "ãã‚‡ã†ã¨"], capital: "äº¬éƒ½", capitalNames: ["äº¬éƒ½", "ãã‚‡ã†ã¨"] },
    { jis: 27, names: ["å¤§é˜ª", "å¤§é˜ªåºœ", "ãŠãŠã•ã‹"], capital: "å¤§é˜ª", capitalNames: ["å¤§é˜ª", "ãŠãŠã•ã‹"] },
    { jis: 28, names: ["å…µåº«", "å…µåº«çœŒ", "ã²ã‚‡ã†ã”"], capital: "ç¥æˆ¸", capitalNames: ["ç¥æˆ¸", "ã“ã†ã¹"] },
    { jis: 29, names: ["å¥ˆè‰¯", "å¥ˆè‰¯çœŒ", "ãªã‚‰"], capital: "å¥ˆè‰¯", capitalNames: ["å¥ˆè‰¯", "ãªã‚‰"] },
    { jis: 30, names: ["å’Œæ­Œå±±", "å’Œæ­Œå±±çœŒ", "ã‚ã‹ã‚„ã¾"], capital: "å’Œæ­Œå±±", capitalNames: ["å’Œæ­Œå±±", "ã‚ã‹ã‚„ã¾"] },
    { jis: 31, names: ["é³¥å–", "é³¥å–çœŒ", "ã¨ã£ã¨ã‚Š"], capital: "é³¥å–", capitalNames: ["é³¥å–", "ã¨ã£ã¨ã‚Š"] },
    { jis: 32, names: ["å³¶æ ¹", "å³¶æ ¹çœŒ", "ã—ã¾ã­"], capital: "æ¾æ±Ÿ", capitalNames: ["æ¾æ±Ÿ", "ã¾ã¤ãˆ"] },
    { jis: 33, names: ["å²¡å±±", "å²¡å±±çœŒ", "ãŠã‹ã‚„ã¾"], capital: "å²¡å±±", capitalNames: ["å²¡å±±", "ãŠã‹ã‚„ã¾"] },
    { jis: 34, names: ["åºƒå³¶", "åºƒå³¶çœŒ", "ã²ã‚ã—ã¾"], capital: "åºƒå³¶", capitalNames: ["åºƒå³¶", "ã²ã‚ã—ã¾"] },
    { jis: 35, names: ["å±±å£", "å±±å£çœŒ", "ã‚„ã¾ãã¡"], capital: "å±±å£", capitalNames: ["å±±å£", "ã‚„ã¾ãã¡"] },
    { jis: 36, names: ["å¾³å³¶", "å¾³å³¶çœŒ", "ã¨ãã—ã¾"], capital: "å¾³å³¶", capitalNames: ["å¾³å³¶", "ã¨ãã—ã¾"] },
    { jis: 37, names: ["é¦™å·", "é¦™å·çœŒ", "ã‹ãŒã‚"], capital: "é«˜æ¾", capitalNames: ["é«˜æ¾", "ãŸã‹ã¾ã¤"] },
    { jis: 38, names: ["æ„›åª›", "æ„›åª›çœŒ", "ãˆã²ã‚"], capital: "æ¾å±±", capitalNames: ["æ¾å±±", "ã¾ã¤ã‚„ã¾"] },
    { jis: 39, names: ["é«˜çŸ¥", "é«˜çŸ¥çœŒ", "ã“ã†ã¡"], capital: "é«˜çŸ¥", capitalNames: ["é«˜çŸ¥", "ã“ã†ã¡"] },
    { jis: 40, names: ["ç¦å²¡", "ç¦å²¡çœŒ", "ãµããŠã‹"], capital: "ç¦å²¡", capitalNames: ["ç¦å²¡", "ãµããŠã‹"] },
    { jis: 41, names: ["ä½è³€", "ä½è³€çœŒ", "ã•ãŒ"], capital: "ä½è³€", capitalNames: ["ä½è³€", "ã•ãŒ"] },
    { jis: 42, names: ["é•·å´", "é•·å´çœŒ", "ãªãŒã•ã"], capital: "é•·å´", capitalNames: ["é•·å´", "ãªãŒã•ã"] },
    { jis: 43, names: ["ç†Šæœ¬", "ç†Šæœ¬çœŒ", "ãã¾ã‚‚ã¨"], capital: "ç†Šæœ¬", capitalNames: ["ç†Šæœ¬", "ãã¾ã‚‚ã¨"] },
    { jis: 44, names: ["å¤§åˆ†", "å¤§åˆ†çœŒ", "ãŠãŠã„ãŸ"], capital: "å¤§åˆ†", capitalNames: ["å¤§åˆ†", "ãŠãŠã„ãŸ"] },
    { jis: 45, names: ["å®®å´", "å®®å´çœŒ", "ã¿ã‚„ã–ã"], capital: "å®®å´", capitalNames: ["å®®å´", "ã¿ã‚„ã–ã"] },
    { jis: 46, names: ["é¹¿å…å³¶", "é¹¿å…å³¶çœŒ", "ã‹ã”ã—ã¾"], capital: "é¹¿å…å³¶", capitalNames: ["é¹¿å…å³¶", "ã‹ã”ã—ã¾"] },
    { jis: 47, names: ["æ²–ç¸„", "æ²–ç¸„çœŒ", "ãŠããªã‚"], capital: "é‚£è¦‡", capitalNames: ["é‚£è¦‡", "ãªã¯"] }
  ];

  let currentPref = null;
  let mistakeCount = 0;
  let mode = "pref";
  let isTalking = false;
  
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  recognition.lang = 'ja-JP';
  recognition.continuous = true;

  // --- åˆæœŸåŒ–ï¼šSVGèª­ã¿è¾¼ã¿ ---
  window.onload = function() {
    fetch('japan.svg')
      .then(response => {
        if (!response.ok) throw new Error("åœ°å›³ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return response.text();
      })
      .then(svgText => {
        document.getElementById('map-container').innerHTML = svgText;
        
        document.getElementById('message').innerText = "ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­";
        document.getElementById('btn-start').disabled = false;
        document.getElementById('btn-start').innerText = "ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆï¼";
      })
      .catch(err => {
        document.getElementById('message').innerText = "ã‚¨ãƒ©ãƒ¼ï¼šåœ°å›³ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“";
        document.getElementById('status').innerText = "japan.svg ãŒåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nChromeã®å ´åˆã¯Netlify Dropç­‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚";
      });
  };

  // --- â˜…é‡è¦ï¼šã“ã®åœ°å›³å°‚ç”¨ã®æ¢ã—æ–¹ ---
  function findPrefectureElement(jisCode) {
    const svg = document.querySelector('svg');
    if (!svg) return null;

    // ã‚ãªãŸã®åœ°å›³ã¯ data-code="01" ã®ã‚ˆã†ã«2æ¡ã®æ•°å­—ã‚’ä½¿ã£ã¦ã„ã¾ã™
    // ãªã®ã§ã€æ•°å­—ã‚’2æ¡ã®æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¾ã™ (1 -> "01")
    const codeStr = jisCode.toString().padStart(2, '0');
    
    // data-code ãŒä¸€è‡´ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—(gã‚¿ã‚°)ã‚’æ¢ã™
    return svg.querySelector(`g[data-code="${codeStr}"]`);
  }

  // --- ã‚²ãƒ¼ãƒ é€²è¡Œ ---
  function startGame() {
    document.getElementById("btn-start").style.display = "none";
    speak("æ—¥æœ¬åœ°å›³ã‚¯ã‚¤ã‚ºï¼èµ¤ããªã£ãŸå ´æ‰€ã®åå‰ã‚’ç­”ãˆã¦ã­ã€‚", () => {
      try { recognition.start(); } catch(e){}
      nextQuestion();
    });
  }

  function nextQuestion() {
    mode = "pref";
    mistakeCount = 0;
    
    // èµ¤è‰²ãƒªã‚»ãƒƒãƒˆ (activeã‚¯ãƒ©ã‚¹ã‚’å¤–ã™)
    document.querySelectorAll('.active').forEach(el => el.classList.remove('active'));

    // ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œ
    const randomIndex = Math.floor(Math.random() * prefectures.length);
    currentPref = prefectures[randomIndex];

    // åœ°å›³ä¸Šã®è¦ç´ ã‚’æ¢ã—ã¦èµ¤ãã™ã‚‹
    const targetEl = findPrefectureElement(currentPref.jis);

    if(targetEl) {
        // ã‚°ãƒ«ãƒ¼ãƒ—(gã‚¿ã‚°)ã«ã‚¯ãƒ©ã‚¹ã‚’ã¤ã‘ã‚‹
        targetEl.classList.add('active');
        speak("ã“ã“ã¯ã©ã“ï¼Ÿ");
    } else {
        console.error(`çœŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (JIS: ${currentPref.jis})`);
        nextQuestion(); // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
    }
  }

  // --- éŸ³å£°èªè­˜ã¨åˆ¤å®š ---
  recognition.onresult = function(event) {
    if (isTalking) return;
    const lastResultIdx = event.results.length - 1;
    const speechText = event.results[lastResultIdx][0].transcript;
    document.getElementById("status").innerText = `ã€Œ${speechText}ã€ã¨èã“ãˆãŸã‚ˆ`;
    checkAnswer(speechText);
  };

  function checkAnswer(text) {
    let isCorrect = false;
    let correctList = (mode === "pref") ? currentPref.names : currentPref.capitalNames;
    
    // éƒ¨åˆ†ä¸€è‡´åˆ¤å®š (ã€Œæ„›çŸ¥çœŒã€ã«å¯¾ã—ã¦ã€Œæ„›çŸ¥ã€ã§ã‚‚OK)
    correctList.forEach(ans => {
      if (text.indexOf(ans) !== -1) isCorrect = true;
    });

    if (isCorrect) {
      if (mode === "pref") {
        speak("ãƒ”ãƒ³ãƒãƒ³ï¼æ­£è§£ï¼", () => {
          mode = "capital";
          mistakeCount = 0;
          speak(`${currentPref.names[0]}ã®ã€çœŒåºæ‰€åœ¨åœ°ã¯ï¼Ÿ`);
        });
      } else {
        speak("ã™ã”ã„ï¼å¤§æ­£è§£ï¼", () => {
          setTimeout(nextQuestion, 1500);
        });
      }
    } else {
      mistakeCount++;
      if (mistakeCount >= 3) {
        const answerText = (mode === "pref") ? currentPref.names[0] : currentPref.capital;
        speak(`ã–ã‚“ã­ã‚“ã€‚æ­£è§£ã¯ã€${answerText}ã€ã ã‚ˆã€‚`, () => nextQuestion());
      } else {
        speak("ã¡ãŒã†ã‚ˆã€‚ã‚‚ã†ä¸€å›ç­”ãˆã¦ã­ã€‚");
      }
    }
  }

  function speak(text, callback) {
    isTalking = true;
    document.getElementById("message").innerText = text;
    const uttr = new SpeechSynthesisUtterance(text);
    uttr.lang = "ja-JP";
    uttr.onend = () => {
      isTalking = false;
      if (callback) callback();
    };
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(uttr);
  }
  
  recognition.onend = function() {
    if(document.getElementById("btn-start").style.display === "none") {
        try { recognition.start(); } catch(e){}
    }
  };
</script>
</body>
</html>