<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒªã‚¢ãƒ«æ—¥æœ¬åœ°å›³ã‚¯ã‚¤ã‚º</title>
<style>
  body { font-family: "Hiragino Maru Gothic Pro", sans-serif; text-align: center; background-color: #e0f7fa; padding: 20px; }
  
  /* åœ°å›³è¡¨ç¤ºã‚¨ãƒªã‚¢ */
  #map-container {
    width: 100%;
    max-width: 800px; /* ãƒªã‚¢ãƒ«åœ°å›³ç”¨ã«å°‘ã—å¤§ãã */
    height: auto;
    margin: 10px auto;
    border: 4px solid #4dd0e1;
    border-radius: 10px;
    background: white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    position: relative;
    min-height: 400px;
  }
  
  /* SVGå†…ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆèª­ã¿è¾¼ã‚“ã å¾Œã«é©ç”¨ã•ã‚Œã¾ã™ï¼‰ */
  svg { width: 100%; height: auto; display: block; }
  path, rect, polygon, g { 
    fill: #b2ebf2; 
    stroke: #fff; 
    stroke-width: 1px; 
    transition: fill 0.2s; 
    cursor: pointer;
  }
  path:hover, rect:hover, polygon:hover { fill: #26c6da; }
  
  /* æ­£è§£ãƒ»å‡ºé¡Œä¸­ã®è‰² */
  .active { fill: #ff5252 !important; }
  .solved { fill: #81c784 !important; }

  /* UI */
  #message { font-size: 22px; font-weight: bold; color: #bf360c; margin: 10px; min-height: 1.5em; }
  #status { color: #555; font-size: 14px; margin-bottom: 20px;}
  button { padding: 15px 40px; font-size: 20px; background: #ffca28; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 4px #c6a700; }
  
  /* IDèª¿æŸ»ãƒ¢ãƒ¼ãƒ‰ç”¨ */
  #debug-info { margin-top: 30px; font-size: 12px; color: #999; border-top: 1px solid #ccc; padding: 10px; display: none;}
</style>
</head>
<body>

<h1>ğŸ—¾ ãƒªã‚¢ãƒ«æ—¥æœ¬åœ°å›³ã‚¯ã‚¤ã‚º</h1>

<div id="game-area">
  <div id="message">åœ°å›³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
  <div id="status"></div>
  <button id="btn-start" onclick="startGame()" disabled>æº–å‚™ä¸­</button>
</div>

<div id="map-container">
  </div>

<div id="debug-info">
  <p>ã€IDèª¿æŸ»ãƒ¢ãƒ¼ãƒ‰ã€‘åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã“ã“ã«IDãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
  ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸåœ°å›³ã«åˆã‚ã›ã¦ã€ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã® `idPrefix` ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚</p>
  <div id="clicked-id"></div>
</div>

<script>
  // â˜…è¨­å®šï¼šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸåœ°å›³ã«åˆã‚ã›ã¦å¤‰æ›´ã™ã‚‹å ´æ‰€
  // å¤šãã®åœ°å›³ã¯ "pref_01" ã‚„ "jp-01" ã®ã‚ˆã†ãªIDãŒã¤ã„ã¦ã„ã¾ã™ã€‚
  // åŒ—æµ·é“(01)ã®IDãŒ "prefecture_1" ãªã‚‰ã€prefixã¯ "prefecture_" ã§ã™ã€‚
  // ä»Šå›æ¨å¥¨ã—ãŸGeoloniaã®åœ°å›³ãªã‚‰ "JP01", "JP02"... ãªã®ã§ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›ã—ã¾ã™ã€‚
  
  // ãƒãƒƒãƒ”ãƒ³ã‚°é–¢æ•°: JISã‚³ãƒ¼ãƒ‰(1ã€œ47)ã‚’å—ã‘å–ã‚Šã€ãã®åœ°å›³ã®IDå½¢å¼ã«ã—ã¦è¿”ã™
  function getMapId(jisCode) {
    // æ•°å€¤ã‚’2æ¡ã«ã™ã‚‹ (ä¾‹: 1 -> "01")
    const code = jisCode.toString().padStart(2, '0');
    
    // â˜…ã“ã“ã‚’åœ°å›³ã«åˆã‚ã›ã¦èª¿æ•´ï¼
    // ä¾‹1: Geolonia/GitHubã®åœ°å›³ã®å ´åˆ (JP01, JP02...)
    return "JP" + code; 
    
    // ä¾‹2: ã‚‚ã— id="pref_01" ã®åœ°å›³ã‚’ä½¿ã†ãªã‚‰
    // return "pref_" + code;
  }

  // --- ãƒ‡ãƒ¼ã‚¿æº–å‚™ ---
  const prefectures = [
    // jis: JISã‚³ãƒ¼ãƒ‰, names: æ­£è§£ã®èª­ã¿æ–¹, capital: çœŒåºæ‰€åœ¨åœ°
    { jis: 1, names: ["åŒ—æµ·é“", "ã»ã£ã‹ã„ã©ã†"], capital: "æœ­å¹Œ", capitalNames: ["æœ­å¹Œ", "ã•ã£ã½ã‚"] },
    { jis: 2, names: ["é’æ£®", "é’æ£®çœŒ", "ã‚ãŠã‚‚ã‚Š"], capital: "é’æ£®", capitalNames: ["é’æ£®", "ã‚ãŠã‚‚ã‚Š"] },
    { jis: 3, names: ["å²©æ‰‹", "å²©æ‰‹çœŒ", "ã„ã‚ã¦"], capital: "ç››å²¡", capitalNames: ["ç››å²¡", "ã‚‚ã‚ŠãŠã‹"] },
    { jis: 4, names: ["å®®åŸ", "å®®åŸçœŒ", "ã¿ã‚„ã"], capital: "ä»™å°", capitalNames: ["ä»™å°", "ã›ã‚“ã ã„"] },
    { jis: 5, names: ["ç§‹ç”°", "ç§‹ç”°çœŒ", "ã‚ããŸ"], capital: "ç§‹ç”°", capitalNames: ["ç§‹ç”°", "ã‚ããŸ"] },
    { jis: 6, names: ["å±±å½¢", "å±±å½¢çœŒ", "ã‚„ã¾ãŒãŸ"], capital: "å±±å½¢", capitalNames: ["å±±å½¢", "ã‚„ã¾ãŒãŸ"] },
    { jis: 7, names: ["ç¦å³¶", "ç¦å³¶çœŒ", "ãµãã—ã¾"], capital: "ç¦å³¶", capitalNames: ["ç¦å³¶", "ãµãã—ã¾"] },
    { jis: 8, names: ["èŒ¨åŸ", "èŒ¨åŸçœŒ", "ã„ã°ã‚‰ã"], capital: "æ°´æˆ¸", capitalNames: ["æ°´æˆ¸", "ã¿ã¨"] },
    { jis: 9, names: ["æ ƒæœ¨", "æ ƒæœ¨çœŒ", "ã¨ã¡ã"], capital: "å®‡éƒ½å®®", capitalNames: ["å®‡éƒ½å®®", "ã†ã¤ã®ã¿ã‚„"] },
    { jis: 10, names: ["ç¾¤é¦¬", "ç¾¤é¦¬çœŒ", "ãã‚“ã¾"], capital: "å‰æ©‹", capitalNames: ["å‰æ©‹", "ã¾ãˆã°ã—"] },
    { jis: 11, names: ["åŸ¼ç‰", "åŸ¼ç‰çœŒ", "ã•ã„ãŸã¾"], capital: "ã•ã„ãŸã¾", capitalNames: ["ã•ã„ãŸã¾", "æµ¦å’Œ"] },
    { jis: 12, names: ["åƒè‘‰", "åƒè‘‰çœŒ", "ã¡ã°"], capital: "åƒè‘‰", capitalNames: ["åƒè‘‰", "ã¡ã°"] },
    { jis: 13, names: ["æ±äº¬", "æ±äº¬éƒ½", "ã¨ã†ãã‚‡ã†"], capital: "æ±äº¬", capitalNames: ["æ±äº¬", "æ–°å®¿"] },
    { jis: 14, names: ["ç¥å¥ˆå·", "ç¥å¥ˆå·çœŒ", "ã‹ãªãŒã‚"], capital: "æ¨ªæµœ", capitalNames: ["æ¨ªæµœ", "ã‚ˆã“ã¯ã¾"] },
    { jis: 15, names: ["æ–°æ½Ÿ", "æ–°æ½ŸçœŒ", "ã«ã„ãŒãŸ"], capital: "æ–°æ½Ÿ", capitalNames: ["æ–°æ½Ÿ", "ã«ã„ãŒãŸ"] },
    { jis: 16, names: ["å¯Œå±±", "å¯Œå±±çœŒ", "ã¨ã‚„ã¾"], capital: "å¯Œå±±", capitalNames: ["å¯Œå±±", "ã¨ã‚„ã¾"] },
    { jis: 17, names: ["çŸ³å·", "çŸ³å·çœŒ", "ã„ã—ã‹ã‚"], capital: "é‡‘æ²¢", capitalNames: ["é‡‘æ²¢", "ã‹ãªã–ã‚"] },
    { jis: 18, names: ["ç¦äº•", "ç¦äº•çœŒ", "ãµãã„"], capital: "ç¦äº•", capitalNames: ["ç¦äº•", "ãµãã„"] },
    { jis: 19, names: ["å±±æ¢¨", "å±±æ¢¨çœŒ", "ã‚„ã¾ãªã—"], capital: "ç”²åºœ", capitalNames: ["ç”²åºœ", "ã“ã†ãµ"] },
    { jis: 20, names: ["é•·é‡", "é•·é‡çœŒ", "ãªãŒã®"], capital: "é•·é‡", capitalNames: ["é•·é‡", "ãªãŒã®"] },
    { jis: 21, names: ["å²é˜œ", "å²é˜œçœŒ", "ããµ"], capital: "å²é˜œ", capitalNames: ["å²é˜œ", "ããµ"] },
    { jis: 22, names: ["é™å²¡", "é™å²¡çœŒ", "ã—ãšãŠã‹"], capital: "é™å²¡", capitalNames: ["é™å²¡", "ã—ãšãŠã‹"] },
    { jis: 23, names: ["æ„›çŸ¥", "æ„›çŸ¥çœŒ", "ã‚ã„ã¡"], capital: "åå¤å±‹", capitalNames: ["åå¤å±‹", "ãªã”ã‚„"] },
    { jis: 24, names: ["ä¸‰é‡", "ä¸‰é‡çœŒ", "ã¿ãˆ"], capital: "æ´¥", capitalNames: ["æ´¥", "ã¤"] },
    { jis: 25, names: ["æ»‹è³€", "æ»‹è³€çœŒ", "ã—ãŒ"], capital: "å¤§æ´¥", capitalNames: ["å¤§æ´¥", "ãŠãŠã¤"] },
    { jis: 26, names: ["äº¬éƒ½", "äº¬éƒ½åºœ", "ãã‚‡ã†ã¨"], capital: "äº¬éƒ½", capitalNames: ["äº¬éƒ½", "ãã‚‡ã†ã¨"] },
    { jis: 27, names: ["å¤§é˜ª", "å¤§é˜ªåºœ", "ãŠãŠã•ã‹"], capital: "å¤§é˜ª", capitalNames: ["å¤§é˜ª", "ãŠãŠã•ã‹"] },
    { jis: 28, names: ["å…µåº«", "å…µåº«çœŒ", "ã²ã‚‡ã†ã”"], capital: "ç¥æˆ¸", capitalNames: ["ç¥æˆ¸", "ã“ã†ã¹"] },
    { jis: 29, names: ["å¥ˆè‰¯", "å¥ˆè‰¯çœŒ", "ãªã‚‰"], capital: "å¥ˆè‰¯", capitalNames: ["å¥ˆè‰¯", "ãªã‚‰"] },
    { jis: 30, names: ["å’Œæ­Œå±±", "å’Œæ­Œå±±çœŒ", "ã‚ã‹ã‚„ã¾"], capital: "å’Œæ­Œå±±", capitalNames: ["å’Œæ­Œå±±", "ã‚ã‹ã‚„ã¾"] },
    { jis: 31, names: ["é³¥å–", "é³¥å–çœŒ", "ã¨ã£ã¨ã‚Š"], capital: "é³¥å–", capitalNames: ["é³¥å–", "ã¨ã£ã¨ã‚Š"] },
    { jis: 32, names: ["å³¶æ ¹", "å³¶æ ¹çœŒ", "ã—ã¾ã­"], capital: "æ¾æ±Ÿ", capitalNames: ["æ¾æ±Ÿ", "ã¾ã¤ãˆ"] },
    { jis: 33, names: ["å²¡å±±", "å²¡å±±çœŒ", "ãŠã‹ã‚„ã¾"], capital: "å²¡å±±", capitalNames: ["å²¡å±±", "ãŠã‹ã‚„ã¾"] },
    { jis: 34, names: ["åºƒå³¶", "åºƒå³¶çœŒ", "ã²ã‚ã—ã¾"], capital: "åºƒå³¶", capitalNames: ["åºƒå³¶", "ã²ã‚ã—ã¾"] },
    { jis: 35, names: ["å±±å£", "å±±å£çœŒ", "ã‚„ã¾ãã¡"], capital: "å±±å£", capitalNames: ["å±±å£", "ã‚„ã¾ãã¡"] },
    { jis: 36, names: ["å¾³å³¶", "å¾³å³¶çœŒ", "ã¨ãã—ã¾"], capital: "å¾³å³¶", capitalNames: ["å¾³å³¶", "ã¨ãã—ã¾"] },
    { jis: 37, names: ["é¦™å·", "é¦™å·çœŒ", "ã‹ãŒã‚"], capital: "é«˜æ¾", capitalNames: ["é«˜æ¾", "ãŸã‹ã¾ã¤"] },
    { jis: 38, names: ["æ„›åª›", "æ„›åª›çœŒ", "ãˆã²ã‚"], capital: "æ¾å±±", capitalNames: ["æ¾å±±", "ã¾ã¤ã‚„ã¾"] },
    { jis: 39, names: ["é«˜çŸ¥", "é«˜çŸ¥çœŒ", "ã“ã†ã¡"], capital: "é«˜çŸ¥", capitalNames: ["é«˜çŸ¥", "ã“ã†ã¡"] },
    { jis: 40, names: ["ç¦å²¡", "ç¦å²¡çœŒ", "ãµããŠã‹"], capital: "ç¦å²¡", capitalNames: ["ç¦å²¡", "ãµããŠã‹"] },
    { jis: 41, names: ["ä½è³€", "ä½è³€çœŒ", "ã•ãŒ"], capital: "ä½è³€", capitalNames: ["ä½è³€", "ã•ãŒ"] },
    { jis: 42, names: ["é•·å´", "é•·å´çœŒ", "ãªãŒã•ã"], capital: "é•·å´", capitalNames: ["é•·å´", "ãªãŒã•ã"] },
    { jis: 43, names: ["ç†Šæœ¬", "ç†Šæœ¬çœŒ", "ãã¾ã‚‚ã¨"], capital: "ç†Šæœ¬", capitalNames: ["ç†Šæœ¬", "ãã¾ã‚‚ã¨"] },
    { jis: 44, names: ["å¤§åˆ†", "å¤§åˆ†çœŒ", "ãŠãŠã„ãŸ"], capital: "å¤§åˆ†", capitalNames: ["å¤§åˆ†", "ãŠãŠã„ãŸ"] },
    { jis: 45, names: ["å®®å´", "å®®å´çœŒ", "ã¿ã‚„ã–ã"], capital: "å®®å´", capitalNames: ["å®®å´", "ã¿ã‚„ã–ã"] },
    { jis: 46, names: ["é¹¿å…å³¶", "é¹¿å…å³¶çœŒ", "ã‹ã”ã—ã¾"], capital: "é¹¿å…å³¶", capitalNames: ["é¹¿å…å³¶", "ã‹ã”ã—ã¾"] },
    { jis: 47, names: ["æ²–ç¸„", "æ²–ç¸„çœŒ", "ãŠããªã‚"], capital: "é‚£è¦‡", capitalNames: ["é‚£è¦‡", "ãªã¯"] }
  ];

  let currentPref = null;
  let mistakeCount = 0;
  let mode = "pref";
  let isTalking = false;
  
  // ãƒã‚¤ã‚¯è¨­å®š
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  recognition.lang = 'ja-JP';
  recognition.continuous = true;

  // --- åˆæœŸåŒ–ï¼šå¤–éƒ¨SVGã®èª­ã¿è¾¼ã¿ ---
  window.onload = function() {
    fetch('japan.svg')
      .then(response => {
        if (!response.ok) throw new Error("åœ°å›³ãƒ•ã‚¡ã‚¤ãƒ«(japan.svg)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return response.text();
      })
      .then(svgText => {
        document.getElementById('map-container').innerHTML = svgText;
        document.getElementById('message').innerText = "ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­";
        document.getElementById('btn-start').disabled = false;
        document.getElementById('btn-start').innerText = "ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆï¼";
        
        // èª­ã¿è¾¼ã¿å¾Œã®ãƒ‡ãƒãƒƒã‚°ç”¨ãƒªã‚¹ãƒŠãƒ¼ï¼ˆåœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰IDã‚’è¡¨ç¤ºï¼‰
        document.querySelector('svg').addEventListener('click', function(e) {
          if (e.target.tagName === 'path' || e.target.tagName === 'rect') {
            document.getElementById('clicked-id').innerText = "ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´æ‰€ã®ID: " + e.target.id;
          }
        });
        document.getElementById('debug-info').style.display = "block";
      })
      .catch(err => {
        document.getElementById('message').innerText = "ã‚¨ãƒ©ãƒ¼: japan.svg ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚";
        document.getElementById('status').innerText = "â€»ã“ã®HTMLã¨åŒã˜å ´æ‰€ã« japan.svg ã‚’ç½®ã„ã¦ãã ã•ã„ã€‚\nâ€»PCã§ç›´æ¥é–‹ãã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã§å‹•ãã¾ã›ã‚“ã€‚Netlify Dropãªã©ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚";
        console.error(err);
      });
  };

  // --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---
  function startGame() {
    document.getElementById("btn-start").style.display = "none";
    document.getElementById('debug-info').style.display = "none"; // ã‚²ãƒ¼ãƒ ä¸­ã¯ãƒ‡ãƒãƒƒã‚°éè¡¨ç¤º
    speak("æ—¥æœ¬åœ°å›³ã‚¯ã‚¤ã‚ºï¼èµ¤ããªã£ãŸå ´æ‰€ã®åå‰ã‚’ç­”ãˆã¦ã­ã€‚", () => {
      try { recognition.start(); } catch(e){}
      nextQuestion();
    });
  }

  function nextQuestion() {
    mode = "pref";
    mistakeCount = 0;
    
    // è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
    const allPaths = document.querySelectorAll('svg path, svg rect, svg polygon');
    allPaths.forEach(el => el.classList.remove('active'));

    // ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œ
    const randomIndex = Math.floor(Math.random() * prefectures.length);
    currentPref = prefectures[randomIndex];

    // SVGä¸Šã®å¯¾è±¡IDã‚’å–å¾—
    const targetId = getMapId(currentPref.jis);
    const targetEl = document.getElementById(targetId);

    if(targetEl) {
        targetEl.classList.add('active');
        speak("ã“ã“ã¯ã©ã“ï¼Ÿ");
    } else {
        console.error("IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + targetId);
        // IDãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ¬¡ã¸ï¼ˆã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
        nextQuestion();
    }
  }

  // --- éŸ³å£°èªè­˜ã¨åˆ¤å®šï¼ˆå‰å›ã¨åŒã˜ï¼‰ ---
  recognition.onresult = function(event) {
    if (isTalking) return;
    const lastResultIdx = event.results.length - 1;
    const speechText = event.results[lastResultIdx][0].transcript;
    document.getElementById("status").innerText = `ã€Œ${speechText}ã€ã¨èã“ãˆãŸã‚ˆ`;
    checkAnswer(speechText);
  };

  function checkAnswer(text) {
    let isCorrect = false;
    let correctList = (mode === "pref") ? currentPref.names : currentPref.capitalNames;
    correctList.forEach(ans => {
      if (text.indexOf(ans) !== -1) isCorrect = true;
    });

    if (isCorrect) {
      if (mode === "pref") {
        speak("ãƒ”ãƒ³ãƒãƒ³ï¼æ­£è§£ï¼", () => {
          mode = "capital";
          mistakeCount = 0;
          speak(`${currentPref.names[0]}ã®ã€çœŒåºæ‰€åœ¨åœ°ã¯ï¼Ÿ`);
        });
      } else {
        speak("ã™ã”ã„ï¼å¤§æ­£è§£ï¼", () => {
          setTimeout(nextQuestion, 1500);
        });
      }
    } else {
      mistakeCount++;
      if (mistakeCount >= 3) {
        const answerText = (mode === "pref") ? currentPref.names[0] : currentPref.capital;
        speak(`ã–ã‚“ã­ã‚“ã€‚æ­£è§£ã¯ã€${answerText}ã€ã ã‚ˆã€‚`, () => nextQuestion());
      } else {
        speak("ã¡ãŒã†ã‚ˆã€‚ã‚‚ã†ä¸€å›ç­”ãˆã¦ã­ã€‚");
      }
    }
  }

  function speak(text, callback) {
    isTalking = true;
    document.getElementById("message").innerText = text;
    const uttr = new SpeechSynthesisUtterance(text);
    uttr.lang = "ja-JP";
    uttr.onend = () => {
      isTalking = false;
      if (callback) callback();
    };
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(uttr);
  }
  
  recognition.onend = function() {
    if(document.getElementById("btn-start").style.display === "none") {
        try { recognition.start(); } catch(e){}
    }
  };
</script>
</body>
</html>